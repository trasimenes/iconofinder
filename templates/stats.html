{% extends "base.html" %}
{% block title %}{{ translate('stats_title') }}{% endblock %}

{% block extra_css %}
<style>
.nav-pills-custom .nav-link {
    color: #697a8d;
    background: #f5f5f9;
}
.nav-pills-custom .nav-link.active {
    color: #fff;
    background: #696cff;
}
</style>
{% endblock %}

{% block content %}
<h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">IconoFinder /</span> {{ translate('stats_title') }}
</h4>

{% if refreshed_at %}
<div class="alert alert-info d-flex align-items-center" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    {{ translate('stats_refreshed') }} {{ refreshed_at }}
</div>
{% endif %}

<div class="mb-4">
    <a href="{{ url_for('refresh_stats') }}" class="btn btn-primary">
        <i class="bi bi-arrow-clockwise me-1"></i> {{ translate('refresh_stats') }}
    </a>
</div>

{% if not stats %}
<div class="card">
    <div class="card-body">
        <p class="text-muted mb-0">{{ translate('no_snapshot_available') }}</p>
    </div>
</div>
{% else %}

<!-- Stats Overview Cards -->
<div class="row mb-4">
    <div class="col-lg-4 col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text">{{ translate('activities') }}</p>
                        <h4 class="card-title mb-0">{{ stats.total_activities }}</h4>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-primary rounded p-2">
                            <i class="bi bi-bicycle fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text">{{ translate('accommodations') }}</p>
                        <h4 class="card-title mb-0">{{ stats.total_housings }}</h4>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-info rounded p-2">
                            <i class="bi bi-house fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text">{{ translate('restaurants') }}</p>
                        <h4 class="card-title mb-0">{{ stats.total_restaurants }}</h4>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-warning rounded p-2">
                            <i class="bi bi-cup-hot fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Table by Country -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title m-0">{{ translate('stats_by_country') if translate('stats_by_country') != 'stats_by_country' else 'Statistiques par pays' }}</h5>
    </div>
    <div class="table-responsive text-nowrap">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>{{ translate('country') }}</th>
                    <th>{{ translate('activities') }}</th>
                    <th>{{ translate('accommodations') }}</th>
                    <th>{{ translate('restaurants') }}</th>
                </tr>
            </thead>
            <tbody>
                {% set countries = (stats.activities.keys() | list + stats.housings.keys() | list + stats.restaurants.keys() | list) | unique %}
                {% for country in countries %}
                <tr>
                    <td><i class="bi bi-geo-alt text-primary me-2"></i>{{ country }}</td>
                    <td>{{ stats.activities.get(country, 0) }}</td>
                    <td>{{ stats.housings.get(country, 0) }}</td>
                    <td>{{ stats.restaurants.get(country, 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Top Missing Activities -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title m-0">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            {{ translate('top_missing_activities') }}
        </h5>
    </div>
    <div class="card-body">
        {% if stats.top_activities_by_country %}
        <ul class="nav nav-pills nav-pills-custom mb-3 flex-wrap" role="tablist">
            {% for country, activities in stats.top_activities_by_country.items() %}
            <li class="nav-item me-2 mb-2" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}" data-bs-toggle="pill" data-bs-target="#country-{{ loop.index }}" type="button" role="tab">
                    {{ country }}
                </button>
            </li>
            {% endfor %}
        </ul>
        <div class="tab-content">
            {% for country, activities in stats.top_activities_by_country.items() %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="country-{{ loop.index }}" role="tabpanel">
                {% if activities %}
                <div class="row">
                    {% for name, count in activities %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>{{ name }}</span>
                                    <span class="badge bg-danger">{{ count }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">{{ translate('no_missing_activities_for_country') }} {{ country }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">{{ translate('no_activities_concerned') }}</p>
        {% endif %}
    </div>
</div>

<!-- Top Missing Housings -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title m-0">
            <i class="bi bi-house-x text-danger me-2"></i>
            {{ translate('top_missing_housings') }}
        </h5>
    </div>
    <div class="card-body">
        {% if stats.top_housings %}
        <div class="row">
            {% for name, count in stats.top_housings %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{{ name }}</span>
                            <span class="badge bg-danger">{{ count }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">{{ translate('no_accommodations_concerned') }}</p>
        {% endif %}
    </div>
</div>

<!-- Top Missing Restaurants -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title m-0">
            <i class="bi bi-cup-straw text-warning me-2"></i>
            {{ translate('top_missing_restaurants') }}
        </h5>
    </div>
    <div class="card-body">
        {% if stats.top_restaurants %}
        <div class="row">
            {% for name, count in stats.top_restaurants %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{{ name }}</span>
                            <span class="badge bg-danger">{{ count }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">{{ translate('no_restaurants_concerned') }}</p>
        {% endif %}
    </div>
</div>

<!-- Housing Types Most Missing -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title m-0">
            <i class="bi bi-bar-chart text-info me-2"></i>
            {{ translate('housing_types_most_missing') }}
        </h5>
    </div>
    <div class="card-body">
        {% if stats.missing_by_type %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Nombre</th>
                    </tr>
                </thead>
                <tbody>
                    {% for typ, count in stats.missing_by_type.items() %}
                    <tr>
                        <td>{{ typ }}</td>
                        <td><span class="badge bg-label-danger">{{ count }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">Aucune donn√©e</p>
        {% endif %}
    </div>
</div>

{% endif %}
{% endblock %}
