{% extends "base.html" %}
{% block title %}Dashboard - IconoFinder{% endblock %}

{% block content %}
<h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">IconoFinder /</span> Dashboard
</h4>

<!-- Stats Cards Row -->
<div class="row">
    <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text" data-translate="missing_photos">Photos manquantes</p>
                        <div class="d-flex align-items-end mb-2">
                            <h4 class="card-title mb-0 me-2">{{ missing_photos }}</h4>
                            <small class="text-danger">(à corriger)</small>
                        </div>
                        <small class="text-muted">Depuis le dernier snapshot</small>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-danger rounded p-2">
                            <i class="bi bi-image fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text" data-translate="total_photos">Photos totales</p>
                        <div class="d-flex align-items-end mb-2">
                            <h4 class="card-title mb-0 me-2">{{ total_photos }}</h4>
                            <small class="text-success"><i class="bi bi-check-circle"></i></small>
                        </div>
                        <small class="text-muted">Dans tous les parcs</small>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-success rounded p-2">
                            <i class="bi bi-images fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text" data-translate="accommodations">Hébergements</p>
                        <div class="d-flex align-items-end mb-2">
                            <h4 class="card-title mb-0 me-2">{{ total_housings }}</h4>
                        </div>
                        <small class="text-muted">Total référencés</small>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-info rounded p-2">
                            <i class="bi bi-house fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="card-info">
                        <p class="card-text" data-translate="restaurants">Restaurants</p>
                        <div class="d-flex align-items-end mb-2">
                            <h4 class="card-title mb-0 me-2">{{ total_restaurants }}</h4>
                        </div>
                        <small class="text-muted">Total référencés</small>
                    </div>
                    <div class="card-icon">
                        <span class="badge bg-label-warning rounded p-2">
                            <i class="bi bi-cup-straw fs-4"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Performance Chart -->
    <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                    <h5 class="m-0 me-2">Performance</h5>
                    <small class="text-muted">Photos corrigées par mois</small>
                </div>
                <div class="dropdown">
                    <button class="btn p-0" type="button" id="performanceDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="performanceDropdown">
                        <a class="dropdown-item" href="javascript:void(0);"><i class="bi bi-download me-2"></i> Exporter</a>
                        <a class="dropdown-item" href="javascript:void(0);"><i class="bi bi-arrow-clockwise me-2"></i> Rafraîchir</a>
                    </div>
                </div>
            </div>
            <div class="card-body px-2 pb-0">
                <canvas id="performanceChart" height="220"></canvas>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    <div class="col-12 col-md-8 col-lg-4 order-1 order-md-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                    <h5 class="m-0 me-2" data-translate="category_distribution">Répartition par catégorie</h5>
                </div>
            </div>
            <div class="card-body">
                <canvas id="pieChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Evolution Chart -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0 me-2">
                    <i class="bi bi-graph-up text-primary me-2"></i>
                    <span data-translate="evolution_missing_photos">Évolution des photos manquantes</span>
                </h5>
            </div>
            <div class="card-body">
                <canvas id="evolutionChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Snapshots History Table -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0">
                    <i class="bi bi-clock-history text-primary me-2"></i>
                    <span data-translate="snapshots_history">Historique des snapshots</span>
                </h5>
                <a href="/snapshots" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-archive me-1"></i> Voir tous
                </a>
            </div>
            <div class="table-responsive text-nowrap">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th data-translate="date">Date</th>
                            <th data-translate="missing_photos">Photos manquantes</th>
                            <th>Restaurants manquants</th>
                            <th data-translate="accommodations">Hébergements</th>
                            <th data-translate="restaurants">Restaurants</th>
                        </tr>
                    </thead>
                    <tbody class="table-border-bottom-0">
                        {% for snap in snapshots %}
                        <tr>
                            <td><i class="bi bi-calendar me-2 text-muted"></i>{{ snap.created_at }}</td>
                            <td><span class="badge bg-label-danger">{{ snap.missing_photos }}</span></td>
                            <td><span class="badge bg-label-warning">{{ snap.missing_restaurants }}</span></td>
                            <td>{{ snap.total_housings }}</td>
                            <td>{{ snap.total_restaurants }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Données injectées par Flask
  const evolutionLabels = {{ evolution_labels|tojson }};
  const evolutionData = {{ evolution_data|tojson }};
  const pieLabels = {{ pie_labels|tojson }};
  const pieData = {{ pie_data|tojson }};

  // Courbe d'évolution
  new Chart(document.getElementById('evolutionChart'), {
    type: 'line',
    data: {
      labels: evolutionLabels,
      datasets: [{
        label: 'Photos manquantes',
        data: evolutionData,
        borderColor: '#696cff',
        backgroundColor: 'rgba(105, 108, 255, 0.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#696cff',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
        x: { grid: { display: false } }
      }
    }
  });

  // Camembert
  new Chart(document.getElementById('pieChart'), {
    type: 'doughnut',
    data: {
      labels: pieLabels,
      datasets: [{
        data: pieData,
        backgroundColor: ['#696cff', '#ffab00', '#ff3e1d', '#71dd37'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } }
      },
      cutout: '70%'
    }
  });

  // Carte Performance dynamique
  const performanceLabels = {{ months|tojson }};
  const performanceActual = {{ actual|tojson }};
  const performanceProjection = {{ projection|tojson }};
  new Chart(document.getElementById('performanceChart'), {
    type: 'bar',
    data: {
      labels: performanceLabels,
      datasets: [
        {
          label: 'Réel',
          data: performanceActual,
          backgroundColor: '#696cff',
          borderRadius: 6,
          barPercentage: 0.6,
        },
        {
          label: 'Projection',
          data: performanceProjection,
          backgroundColor: '#d9dee3',
          borderRadius: 6,
          barPercentage: 0.6,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true, position: 'top', labels: { usePointStyle: true } },
        title: { display: false }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
        x: { grid: { display: false } }
      }
    }
  });
</script>
{% endblock %}
