<!DOCTYPE html>
<html lang="{{ session.get('language', 'fr') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IconoFinder - Center Parcs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
{% include '_navbar.html' %}

    <div class="container py-4">
        {% if snapshot_date %}
            <div class="alert alert-info text-center mb-4">
                Données issues du dernier snapshot le {{ snapshot_date }}
            </div>
        {% endif %}
        {% if error %}
            <div class="alert alert-danger" data-translate="error">
                {{ translate(error) }}
            </div>
        {% else %}
            <!-- Navigation tabs -->
            <ul class="nav nav-pills mb-4" role="tablist">
                {% for country in countries %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}" 
                            data-bs-toggle="pill" 
                            data-bs-target="#{{ country|lower }}" 
                            type="button" 
                            role="tab">
                        {{ country }}
                    </button>
                </li>
                {% endfor %}
            </ul>

            <!-- Tab content -->
            <div class="tab-content">
                {% for country in countries %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="{{ country|lower }}" 
                     role="tabpanel"
                     data-country="{{ country }}"
                     data-loaded="false">
                    
                    <div class="country-loading">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden" data-translate="loading">{{ translate('loading') }}</span>
                            </div>
                        </div>
                        <p class="text-center mt-2" data-translate="searching_for">{{ translate('searching_for') }} {{ country }}...</p>
                    </div>

                    <div class="country-results" style="display: none;">
                        <!-- Les résultats seront injectés ici -->
                    </div>

                    <div class="country-error alert alert-danger" style="display: none;">
                        <!-- Les erreurs seront affichées ici -->
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Initialiser les traductions au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        const currentLang = document.documentElement.lang;
        // Pas besoin d'appeler updateTranslations ici car on utilise déjà translate()
    });

    function toggleLanguage(switchElement) {
        const currentLang = switchElement.getAttribute('data-language');
        const newLang = currentLang === 'fr' ? 'en' : 'fr';
        
        // Rediriger vers la nouvelle langue
        window.location.href = `/set_language/${newLang}?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
    }

    // Fonction pour charger les résultats d'un pays
    async function loadCountryResults(country, searchType, parc) {
        const tabPane = document.querySelector(`#${country.toLowerCase()}`);
        if (!tabPane || tabPane.getAttribute('data-loaded') === 'true') return;

        let lang = document.documentElement.lang || 'fr';

        try {
            // Détecter si on est sur /results_from_snapshot
            let apiUrl;
            if (window.location.pathname.startsWith('/results_from_snapshot')) {
                apiUrl = `/api/snapshot_results?country=${country}&parc=${parc}&type=${searchType}`;
            } else {
                apiUrl = `/api/search?country=${country}&parc=${parc}&type=${searchType}`;
            }
            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // Cacher le loader
            tabPane.querySelector('.country-loading').style.display = 'none';

            // Construire le HTML des résultats
            const resultsContainer = tabPane.querySelector('.country-results');
            let resultsHtml = '';

            // Variables pour vérifier si tout va bien
            let allParksOk = true;
            let detailedResults = '';

            // Patch pour n'afficher QUE les blocs pertinents selon le type de recherche
            const isRestaurants = searchType === 'Restaurants';
            const isHousings = searchType === 'Hébergements';
            const isActivities = searchType === 'Activités';

            // Calculer l'état global des photos
            let hasMissingPhotos = false;
            for (const countryKey of (country === "Tous" ? Object.keys(data.results) : [country])) {
                for (const parkKey in data.results[countryKey]) {
                    const parkData = data.results[countryKey][parkKey];
                    if (isActivities && parkData.activities) {
                        for (const a of parkData.activities) {
                            if (!a.image_src || a.image_src.includes('default')) {
                                hasMissingPhotos = true;
                                break;
                            }
                        }
                    } else if (isRestaurants && parkData.restaurants) {
                        for (const r of parkData.restaurants) {
                            if (!r.has_photos) {
                                hasMissingPhotos = true;
                                break;
                            }
                        }
                    }
                    if (hasMissingPhotos) break;
                }
                if (hasMissingPhotos) break;
            }
            // Afficher le bandeau global
            resultsHtml += `
                <div class="alert ${hasMissingPhotos ? 'alert-warning' : 'alert-success'} mb-4">
                    <i class="bi bi-${hasMissingPhotos ? 'exclamation-triangle-fill' : 'check-circle-fill'}"></i>
                    ${hasMissingPhotos ? (lang === 'en' ? 'Missing pictures' : 'Photos manquantes') : (lang === 'en' ? 'Pictures OK' : 'Photos OK')}
                </div>
            `;

            // Fonction utilitaire pour générer des IDs sûrs
            function safeId(str) {
                return str.replace(/[^a-zA-Z0-9]/g, '');
            }

            // Parcourir les parcs du pays
            if (country === "Tous") {
                let accordionId = `accordion-${country.toLowerCase()}`;
                resultsHtml += `<div class="accordion mb-4" id="${accordionId}">`;
                let parcIndex = 0;
                for (const [countryName, parks] of Object.entries(data.results)) {
                    for (const [parkName, parkData] of Object.entries(parks)) {
                        let safePanel = safeId(`${countryName}-${parkName}`);
                        let panelId = `${accordionId}-panel-${safePanel}`;
                        let headingId = `${panelId}-heading`;
                        let collapseId = `${panelId}-collapse`;
                        let isOpen = false;
                        resultsHtml += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="${headingId}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    ${countryName} - ${parkName}
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" data-bs-parent="#${accordionId}">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                    `;
                        if (isRestaurants) {
                            resultsHtml += `
                                        <b>Restaurants</b>
                                        <ul class="list-group mb-2">`;
                            if (Array.isArray(parkData.restaurants) && parkData.restaurants.length > 0) {
                                parkData.restaurants.forEach(r => {
                                    resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${r.name}
                                        <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                            <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                        </span>
                                    </li>`;
                                });
                            } else {
                                resultsHtml += `<li class="list-group-item">Aucun restaurant</li>`;
                            }
                            resultsHtml += `</ul>
                                        <b>Supermarchés & boutiques</b>
                                        <ul class="list-group mb-2">`;
                            if (Array.isArray(parkData.supermarches) && parkData.supermarches.length > 0) {
                                parkData.supermarches.forEach(r => {
                                    resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${r.name}
                                        <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                            <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                        </span>
                                    </li>`;
                                });
                            } else {
                                resultsHtml += `<li class="list-group-item">Aucun supermarché</li>`;
                            }
                            resultsHtml += `</ul>
                                        <b>Services</b>
                                        <ul class="list-group mb-2">`;
                            if (Array.isArray(parkData.services) && parkData.services.length > 0) {
                                parkData.services.forEach(r => {
                                    resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${r.name}
                                        <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                            <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                        </span>
                                    </li>`;
                                });
                            } else {
                                resultsHtml += `<li class="list-group-item">Aucun service</li>`;
                            }
                            resultsHtml += `</ul>
                                        <b>Forfaits</b>
                                        <ul class="list-group mb-2">`;
                            if (Array.isArray(parkData.forfaits) && parkData.forfaits.length > 0) {
                                parkData.forfaits.forEach(r => {
                                    resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${r.name}
                                        <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                            <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                        </span>
                                    </li>`;
                                });
                            } else {
                                resultsHtml += `<li class="list-group-item">Aucun forfait</li>`;
                            }
                            resultsHtml += `</ul>`;
                        }
                        if (isActivities) {
                            const activities = Array.isArray(parkData.activities) ? parkData.activities : [];
                            const missing = activities.filter(a => !a.image_src || a.image_src.includes('default'));
                            const ok = activities.filter(a => a.image_src && !a.image_src.includes('default'));
                            const allPhotosOk = activities.length > 0 && missing.length === 0;
                            resultsHtml += `<div>`;
                            if (activities.length === 0) {
                                resultsHtml += `<div class='alert alert-secondary'>Aucune activité trouvée.</div>`;
                            } else if (allPhotosOk) {
                                // Message multilingue selon la langue courante
                                let msg = (lang === 'en')
                                    ? 'All activities in this park have a valid photo.'
                                    : 'Toutes les activités de ce parc possèdent une photo valide.';
                                resultsHtml += `<div class='alert alert-success'>${msg}</div>`;
                                if (ok.length > 0) {
                                    const okCollapseId = `${panelId}-ok-activities-collapse`;
                                    resultsHtml += `
                                        <div class='accordion' id='${panelId}-ok-accordion'>
                                          <div class='accordion-item'>
                                            <h2 class='accordion-header' id='${panelId}-ok-heading'>
                                              <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                                ${lang === 'en' ? 'See activities with photo' : 'Voir les activités avec photo OK'}
                                              </button>
                                            </h2>
                                            <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-heading' data-bs-parent='#${panelId}-ok-accordion'>
                                              <div class='accordion-body'>
                                                <ul class='list-group'>`;
                                    ok.forEach(a => {
                                        resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                            ${a.name}
                                            <span class='badge bg-success rounded-pill'>
                                                <i class='bi bi-check-circle'></i> photo ok
                                            </span>
                                        </li>`;
                                    });
                                    resultsHtml += `</ul></div></div></div></div>`;
                                }
                            } else {
                                if (missing.length > 0) {
                                    resultsHtml += `<div class='mb-2'><b>${lang === 'en' ? 'Activities with missing pictures' : 'Activités avec photo manquante'}</b></div><ul class='list-group mb-3'>`;
                                    missing.forEach(a => {
                                        resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                            ${a.name}
                                            <span class='badge bg-danger rounded-pill'>
                                                <i class='bi bi-exclamation-circle'></i> photo manquante
                                            </span>
                                        </li>`;
                                    });
                                    resultsHtml += `</ul>`;
                                }
                                if (ok.length > 0) {
                                    const okCollapseId = `${panelId}-ok-activities-collapse`;
                                    resultsHtml += `
                                        <div class='accordion' id='${panelId}-ok-accordion'>
                                          <div class='accordion-item'>
                                            <h2 class='accordion-header' id='${panelId}-ok-heading'>
                                              <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                                ${lang === 'en' ? 'See activities with photo' : 'Voir les activités avec photo OK'}
                                              </button>
                                            </h2>
                                            <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-heading' data-bs-parent='#${panelId}-ok-accordion'>
                                              <div class='accordion-body'>
                                                <ul class='list-group'>`;
                                    ok.forEach(a => {
                                        resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                            ${a.name}
                                            <span class='badge bg-success rounded-pill'>
                                                <i class='bi bi-check-circle'></i> photo ok
                                            </span>
                                        </li>`;
                                    });
                                    resultsHtml += `</ul></div></div></div></div>`;
                                }
                            }
                            resultsHtml += `</div>`;
                        }
                        if (isHousings) {
                            const housings = Array.isArray(parkData.housings) ? parkData.housings : [];
                            const missing = housings.filter(h => !h.image_src || h.image_src.includes('default'));
                            const ok = housings.filter(h => h.image_src && !h.image_src.includes('default'));
                            const allPhotosOk = housings.length > 0 && missing.length === 0;
                            resultsHtml += `<div>`;
                            if (housings.length === 0) {
                                resultsHtml += `<div class='alert alert-secondary'>Aucun hébergement trouvé.</div>`;
                            } else if (allPhotosOk) {
                                // Message multilingue selon la langue courante
                                let msg = (lang === 'en')
                                    ? 'All accommodations in this park have a valid photo.'
                                    : 'Tous les hébergements de ce parc possèdent une photo valide.';
                                resultsHtml += `<div class='alert alert-success'>${msg}</div>`;
                                if (ok.length > 0) {
                                    const okCollapseId = `${panelId}-ok-housings-collapse`;
                                    resultsHtml += `
                                        <div class='accordion' id='${panelId}-ok-housings-accordion'>
                                          <div class='accordion-item'>
                                            <h2 class='accordion-header' id='${panelId}-ok-housings-heading'>
                                              <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                                ${lang === 'en' ? 'See accommodations with photo' : 'Voir les hébergements avec photo OK'}
                                              </button>
                                            </h2>
                                            <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-housings-heading' data-bs-parent='#${panelId}-ok-housings-accordion'>
                                              <div class='accordion-body'>
                                                <ul class='list-group'>`;
                                    ok.forEach(h => {
                                        resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                            <div>
                                                <b>${h.cottage_id}</b> &mdash; ${h.type} &mdash; ${h.capacity} pers.<br>
                                                <span style='color:#888;'>${h.name}</span>
                                            </div>
                                            <span class='badge bg-success rounded-pill'>
                                                <i class='bi bi-check-circle'></i> photo ok
                                            </span>
                                        </li>`;
                                    });
                                    resultsHtml += `</ul></div></div></div></div>`;
                                }
                            } else {
                                if (missing.length > 0) {
                                    resultsHtml += `<div class='mb-2'><b>Hébergements avec photo manquante</b></div><ul class='list-group mb-3'>`;
                                    missing.forEach(h => {
                                        resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                            <div>
                                                <b>${h.cottage_id}</b> &mdash; ${h.type} &mdash; ${h.capacity} pers.<br>
                                                <span style='color:#888;'>${h.name}</span>
                                            </div>
                                            <span class='badge bg-danger rounded-pill'>
                                                <i class='bi bi-exclamation-circle'></i> photo manquante
                                            </span>
                                        </li>`;
                                    });
                                    resultsHtml += `</ul>`;
                                }
                                if (ok.length > 0) {
                                    const okCollapseId = `${panelId}-ok-housings-collapse`;
                                    resultsHtml += `
                                        <div class='accordion' id='${panelId}-ok-housings-accordion'>
                                          <div class='accordion-item'>
                                            <h2 class='accordion-header' id='${panelId}-ok-housings-heading'>
                                              <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                                ${lang === 'en' ? 'See accommodations with photo' : 'Voir les hébergements avec photo OK'}
                                              </button>
                                            </h2>
                                            <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-housings-heading' data-bs-parent='#${panelId}-ok-housings-accordion'>
                                              <div class='accordion-body'>
                                                <ul class='list-group'>`;
                                    ok.forEach(h => {
                                        resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                            <div>
                                                <b>${h.cottage_id}</b> &mdash; ${h.type} &mdash; ${h.capacity} pers.<br>
                                                <span style='color:#888;'>${h.name}</span>
                                            </div>
                                            <span class='badge bg-success rounded-pill'>
                                                <i class='bi bi-check-circle'></i> photo ok
                                            </span>
                                        </li>`;
                                    });
                                    resultsHtml += `</ul></div></div></div></div>`;
                                }
                            }
                            resultsHtml += `</div>`;
                        }
                        resultsHtml += `</div>`;
                        if (!isActivities && !isHousings) {
                            resultsHtml += `<button class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#details-${panelId}">
                                Afficher tous les détails
                            </button>`;
                        }
                        resultsHtml += `</div>
                                    <div class="collapse" id="details-${panelId}">
                                        <div class="accordion" id="details-accordion-${panelId}">`;
                        if (isRestaurants) {
                            [
                                {typ: 'Restaurants', arr: parkData.restaurants},
                                {typ: 'Supermarches', arr: parkData.supermarches},
                                {typ: 'Services', arr: parkData.services},
                                {typ: 'Forfaits', arr: parkData.forfaits}
                            ].forEach(({typ, arr}, idx) => {
                                const items = Array.isArray(arr) ? arr : [];
                                const typLabel = typ === 'Supermarches' ? 'Supermarchés & boutiques' : (typ === 'Forfaits' ? 'Forfaits' : (typ === 'Services' ? 'Services' : 'Restaurants'));
                                const typPanelId = `details-${panelId}-${typ}`;
                                resultsHtml += `
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="${typPanelId}-heading">
                                                    <button class="accordion-button ${idx === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${typPanelId}-collapse" aria-expanded="${idx === 0 ? 'true' : 'false'}" aria-controls="${typPanelId}-collapse">
                                                        ${typLabel} <span class="badge bg-primary ms-2">${items.length}</span>
                                                    </button>
                                                </h2>
                                                <div id="${typPanelId}-collapse" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" aria-labelledby="${typPanelId}-heading" data-bs-parent="#details-accordion-${panelId}">
                                                    <div class="accordion-body">
                                                        <ul class="list-group">`;
                                if (items.length > 0) {
                                    items.forEach(r => {
                                        resultsHtml += `<li class="list-group-item"><b>${r.name}</b><br>`;
                                        if (r.description) resultsHtml += `<i>${r.description}</i><br>`;
                                        if (r.cuisine_type) resultsHtml += `<b>Type :</b> ${r.cuisine_type}<br>`;
                                        if (r.horaires) resultsHtml += `<b>Horaires :</b> ${r.horaires}<br>`;
                                        if (r.link) resultsHtml += `<a href="${r.link}" target="_blank">Voir le menu</a><br>`;
                                        if (r.images && r.images.length > 0) {
                                            resultsHtml += r.images.filter(img => !!img).map(img => `<img src="${img}" alt="photo ${r.name}" style="max-width:120px;max-height:80px;margin:2px;" />`).join('');
                                        }
                                        resultsHtml += `</li>`;
                                    });
                                } else {
                                    resultsHtml += `<li class="list-group-item">Aucun ${typLabel.toLowerCase()}</li>`;
                                }
                                resultsHtml += `</ul></div></div></div>`;
                            });
                        }
                        resultsHtml += `</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        parcIndex++;
                    }
                }
                resultsHtml += `</div>`;
            } else {
                let accordionId = `accordion-${country.toLowerCase()}`;
                resultsHtml += `<div class="accordion mb-4" id="${accordionId}">`;
                let parcIndex = 0;
                for (const [parkName, parkData] of Object.entries(data.results[country] || {})) {
                    let safePanel = safeId(parkName);
                    let panelId = `${accordionId}-panel-${safePanel}`;
                    let headingId = `${panelId}-heading`;
                    let collapseId = `${panelId}-collapse`;
                    let isOpen = false;
                    resultsHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${headingId}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                ${parkName}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" data-bs-parent="#${accordionId}">
                            <div class="accordion-body">
                                <div class="mb-3">
                                `;
                    if (isRestaurants) {
                        resultsHtml += `
                                    <b>Restaurants</b>
                                    <ul class="list-group mb-2">`;
                        if (Array.isArray(parkData.restaurants) && parkData.restaurants.length > 0) {
                            parkData.restaurants.forEach(r => {
                                resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${r.name}
                                    <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                        <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                    </span>
                                </li>`;
                            });
                        } else {
                            resultsHtml += `<li class="list-group-item">Aucun restaurant</li>`;
                        }
                        resultsHtml += `</ul>
                                    <b>Supermarchés & boutiques</b>
                                    <ul class="list-group mb-2">`;
                        if (Array.isArray(parkData.supermarches) && parkData.supermarches.length > 0) {
                            parkData.supermarches.forEach(r => {
                                resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${r.name}
                                    <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                        <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                    </span>
                                </li>`;
                            });
                        } else {
                            resultsHtml += `<li class="list-group-item">Aucun supermarché</li>`;
                        }
                        resultsHtml += `</ul>
                                    <b>Services</b>
                                    <ul class="list-group mb-2">`;
                        if (Array.isArray(parkData.services) && parkData.services.length > 0) {
                            parkData.services.forEach(r => {
                                resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${r.name}
                                    <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                        <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                    </span>
                                </li>`;
                            });
                        } else {
                            resultsHtml += `<li class="list-group-item">Aucun service</li>`;
                        }
                        resultsHtml += `</ul>
                                    <b>Forfaits</b>
                                    <ul class="list-group mb-2">`;
                        if (Array.isArray(parkData.forfaits) && parkData.forfaits.length > 0) {
                            parkData.forfaits.forEach(r => {
                                resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${r.name}
                                    <span class="badge ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'bg-success' : 'bg-danger')} rounded-pill">
                                        <i class="bi bi-${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'check-circle' : 'exclamation-circle')}"></i> ${((r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1') ? 'photo ok' : 'photo manquante')}
                                    </span>
                                </li>`;
                            });
                        } else {
                            resultsHtml += `<li class="list-group-item">Aucun forfait</li>`;
                        }
                        resultsHtml += `</ul>`;
                    }
                    if (isActivities) {
                        const activities = Array.isArray(parkData.activities) ? parkData.activities : [];
                        const missing = activities.filter(a => !a.image_src || a.image_src.includes('default'));
                        const ok = activities.filter(a => a.image_src && !a.image_src.includes('default'));
                        const allPhotosOk = activities.length > 0 && missing.length === 0;
                        resultsHtml += `<div>`;
                        if (activities.length === 0) {
                            resultsHtml += `<div class='alert alert-secondary'>Aucune activité trouvée.</div>`;
                        } else if (allPhotosOk) {
                            // Message multilingue selon la langue courante
                            let msg = (lang === 'en')
                                ? 'All activities in this park have a valid photo.'
                                : 'Toutes les activités de ce parc possèdent une photo valide.';
                            resultsHtml += `<div class='alert alert-success'>${msg}</div>`;
                            if (ok.length > 0) {
                                const okCollapseId = `${panelId}-ok-activities-collapse`;
                                resultsHtml += `
                                    <div class='accordion' id='${panelId}-ok-accordion'>
                                      <div class='accordion-item'>
                                        <h2 class='accordion-header' id='${panelId}-ok-heading'>
                                          <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                            ${lang === 'en' ? 'See activities with photo' : 'Voir les activités avec photo OK'}
                                          </button>
                                        </h2>
                                        <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-heading' data-bs-parent='#${panelId}-ok-accordion'>
                                          <div class='accordion-body'>
                                            <ul class='list-group'>`;
                                ok.forEach(a => {
                                    resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                        ${a.name}
                                        <span class='badge bg-success rounded-pill'>
                                            <i class='bi bi-check-circle'></i> photo ok
                                        </span>
                                    </li>`;
                                });
                                resultsHtml += `</ul></div></div></div></div>`;
                            }
                        } else {
                            if (missing.length > 0) {
                                resultsHtml += `<div class='mb-2'><b>${lang === 'en' ? 'Activities with missing pictures' : 'Activités avec photo manquante'}</b></div><ul class='list-group mb-3'>`;
                                missing.forEach(a => {
                                    resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                        ${a.name}
                                        <span class='badge bg-danger rounded-pill'>
                                            <i class='bi bi-exclamation-circle'></i> photo manquante
                                        </span>
                                    </li>`;
                                });
                                resultsHtml += `</ul>`;
                            }
                            if (ok.length > 0) {
                                const okCollapseId = `${panelId}-ok-activities-collapse`;
                                resultsHtml += `
                                    <div class='accordion' id='${panelId}-ok-accordion'>
                                      <div class='accordion-item'>
                                        <h2 class='accordion-header' id='${panelId}-ok-heading'>
                                          <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                            ${lang === 'en' ? 'See activities with photo' : 'Voir les activités avec photo OK'}
                                          </button>
                                        </h2>
                                        <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-heading' data-bs-parent='#${panelId}-ok-accordion'>
                                          <div class='accordion-body'>
                                            <ul class='list-group'>`;
                                ok.forEach(a => {
                                    resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                        ${a.name}
                                        <span class='badge bg-success rounded-pill'>
                                            <i class='bi bi-check-circle'></i> photo ok
                                        </span>
                                    </li>`;
                                });
                                resultsHtml += `</ul></div></div></div></div>`;
                            }
                        }
                        resultsHtml += `</div>`;
                    }
                    if (isHousings) {
                        const housings = Array.isArray(parkData.housings) ? parkData.housings : [];
                        const missing = housings.filter(h => !h.image_src || h.image_src.includes('default'));
                        const ok = housings.filter(h => h.image_src && !h.image_src.includes('default'));
                        const allPhotosOk = housings.length > 0 && missing.length === 0;
                        resultsHtml += `<div>`;
                        if (housings.length === 0) {
                            resultsHtml += `<div class='alert alert-secondary'>Aucun hébergement trouvé.</div>`;
                        } else if (allPhotosOk) {
                            // Message multilingue selon la langue courante
                            let msg = (lang === 'en')
                                ? 'All accommodations in this park have a valid photo.'
                                : 'Tous les hébergements de ce parc possèdent une photo valide.';
                            resultsHtml += `<div class='alert alert-success'>${msg}</div>`;
                            if (ok.length > 0) {
                                const okCollapseId = `${panelId}-ok-housings-collapse`;
                                resultsHtml += `
                                    <div class='accordion' id='${panelId}-ok-housings-accordion'>
                                      <div class='accordion-item'>
                                        <h2 class='accordion-header' id='${panelId}-ok-housings-heading'>
                                          <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                            ${lang === 'en' ? 'See accommodations with photo' : 'Voir les hébergements avec photo OK'}
                                          </button>
                                        </h2>
                                        <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-housings-heading' data-bs-parent='#${panelId}-ok-housings-accordion'>
                                          <div class='accordion-body'>
                                            <ul class='list-group'>`;
                                ok.forEach(h => {
                                    resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                        <div>
                                            <b>${h.cottage_id}</b> &mdash; ${h.type} &mdash; ${h.capacity} pers.<br>
                                            <span style='color:#888;'>${h.name}</span>
                                        </div>
                                        <span class='badge bg-success rounded-pill'>
                                            <i class='bi bi-check-circle'></i> photo ok
                                        </span>
                                    </li>`;
                                });
                                resultsHtml += `</ul></div></div></div></div>`;
                            }
                        } else {
                            if (missing.length > 0) {
                                resultsHtml += `<div class='mb-2'><b>Hébergements avec photo manquante</b></div><ul class='list-group mb-3'>`;
                                missing.forEach(h => {
                                    resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                        <div>
                                            <b>${h.cottage_id}</b> &mdash; ${h.type} &mdash; ${h.capacity} pers.<br>
                                            <span style='color:#888;'>${h.name}</span>
                                        </div>
                                        <span class='badge bg-danger rounded-pill'>
                                            <i class='bi bi-exclamation-circle'></i> photo manquante
                                        </span>
                                    </li>`;
                                });
                                resultsHtml += `</ul>`;
                            }
                            if (ok.length > 0) {
                                const okCollapseId = `${panelId}-ok-housings-collapse`;
                                resultsHtml += `
                                    <div class='accordion' id='${panelId}-ok-housings-accordion'>
                                      <div class='accordion-item'>
                                        <h2 class='accordion-header' id='${panelId}-ok-housings-heading'>
                                          <button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#${okCollapseId}' aria-expanded='false' aria-controls='${okCollapseId}'>
                                            ${lang === 'en' ? 'See accommodations with photo' : 'Voir les hébergements avec photo OK'}
                                          </button>
                                        </h2>
                                        <div id='${okCollapseId}' class='accordion-collapse collapse' aria-labelledby='${panelId}-ok-housings-heading' data-bs-parent='#${panelId}-ok-housings-accordion'>
                                          <div class='accordion-body'>
                                            <ul class='list-group'>`;
                                ok.forEach(h => {
                                    resultsHtml += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                                        <div>
                                            <b>${h.cottage_id}</b> &mdash; ${h.type} &mdash; ${h.capacity} pers.<br>
                                            <span style='color:#888;'>${h.name}</span>
                                        </div>
                                        <span class='badge bg-success rounded-pill'>
                                            <i class='bi bi-check-circle'></i> photo ok
                                        </span>
                                    </li>`;
                                });
                                resultsHtml += `</ul></div></div></div></div>`;
                            }
                        }
                        resultsHtml += `</div>`;
                    }
                    resultsHtml += `</div>
                                <div class="collapse" id="details-${panelId}">
                                    <div class="accordion" id="details-accordion-${panelId}">`;
                    if (isRestaurants) {
                        [
                            {typ: 'Restaurants', arr: parkData.restaurants},
                            {typ: 'Supermarches', arr: parkData.supermarches},
                            {typ: 'Services', arr: parkData.services},
                            {typ: 'Forfaits', arr: parkData.forfaits}
                        ].forEach(({typ, arr}, idx) => {
                            const items = Array.isArray(arr) ? arr : [];
                            const typLabel = typ === 'Supermarches' ? 'Supermarchés & boutiques' : (typ === 'Forfaits' ? 'Forfaits' : (typ === 'Services' ? 'Services' : 'Restaurants'));
                            const typPanelId = `details-${panelId}-${typ}`;
                            resultsHtml += `
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="${typPanelId}-heading">
                                                <button class="accordion-button ${idx === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#${typPanelId}-collapse" aria-expanded="${idx === 0 ? 'true' : 'false'}" aria-controls="${typPanelId}-collapse">
                                                    ${typLabel} <span class="badge bg-primary ms-2">${items.length}</span>
                                                </button>
                                            </h2>
                                            <div id="${typPanelId}-collapse" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" aria-labelledby="${typPanelId}-heading" data-bs-parent="#details-accordion-${panelId}">
                                                <div class="accordion-body">
                                                    <ul class="list-group">`;
                            if (items.length > 0) {
                                items.forEach(r => {
                                    resultsHtml += `<li class="list-group-item"><b>${r.name}</b><br>`;
                                    if (r.description) resultsHtml += `<i>${r.description}</i><br>`;
                                    if (r.cuisine_type) resultsHtml += `<b>Type :</b> ${r.cuisine_type}<br>`;
                                    if (r.horaires) resultsHtml += `<b>Horaires :</b> ${r.horaires}<br>`;
                                    if (r.link) resultsHtml += `<a href="${r.link}" target="_blank">Voir le menu</a><br>`;
                                    if (r.images && r.images.length > 0) {
                                        resultsHtml += r.images.filter(img => !!img).map(img => `<img src="${img}" alt="photo ${r.name}" style="max-width:120px;max-height:80px;margin:2px;" />`).join('');
                                    }
                                    resultsHtml += `</li>`;
                                });
                            } else {
                                resultsHtml += `<li class="list-group-item">Aucun ${typLabel.toLowerCase()}</li>`;
                            }
                            resultsHtml += `</ul></div></div></div>`;
                        });
                    }
                    resultsHtml += `</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    parcIndex++;
                }
                resultsHtml += `</div>`;
            }

            // Afficher les résultats
            resultsContainer.innerHTML = resultsHtml;
            resultsContainer.style.display = 'block';
            // Mettre à jour les traductions
            updateTranslations(resultsContainer);
            // Marquer comme chargé
            tabPane.setAttribute('data-loaded', 'true');

        } catch (error) {
            // Afficher l'erreur
            tabPane.querySelector('.country-loading').style.display = 'none';
            const errorContainer = tabPane.querySelector('.country-error');
            errorContainer.textContent = `Erreur lors du chargement des résultats : ${error.message}`;
            errorContainer.style.display = 'block';
        }
    }

    // Gestionnaire d'événements pour le changement d'onglet
    document.addEventListener('shown.bs.tab', function (event) {
        const country = event.target.textContent.trim();
        const searchType = new URLSearchParams(window.location.search).get('type');
        const parc = new URLSearchParams(window.location.search).get('parc');
        loadCountryResults(country, searchType, parc);
    });

    // Charger les résultats du premier pays au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        const firstCountry = document.querySelector('.nav-link.active').textContent.trim();
        const searchType = new URLSearchParams(window.location.search).get('type');
        const parc = new URLSearchParams(window.location.search).get('parc');
        loadCountryResults(firstCountry, searchType, parc);
    });

    // Fonction pour mettre à jour les traductions après le chargement dynamique
    function updateTranslations(container) {
        const currentLang = document.documentElement.lang;
        fetch(`/set_language/${currentLang}?next=${encodeURIComponent(window.location.pathname + window.location.search)}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                container.querySelectorAll('[data-translate]').forEach(element => {
                    const key = element.getAttribute('data-translate');
                    if (data.translations && data.translations[key]) {
                        element.textContent = data.translations[key];
                    }
                });
            }
        });
    }
    </script>
</body>
</html>
