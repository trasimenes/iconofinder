{% extends "base.html" %}

{% block title %}Résultats - IconoFinder{% endblock %}

{% block extra_css %}
<style>
/* Skeleton Loading Styles */
@keyframes skeleton-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

@keyframes skeleton-shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.skeleton-container {
    animation: skeleton-pulse 1.5s ease-in-out infinite;
}

.skeleton-alert {
    height: 50px;
    border-radius: 6px;
    background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 50%, #e9ecef 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
}

.skeleton-title {
    height: 24px;
    width: 250px;
    border-radius: 4px;
    background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 50%, #e9ecef 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
}

.skeleton-card {
    border: 1px solid #e9ecef;
}

.skeleton-card .card-header {
    background: #f8f9fa;
    padding: 1rem;
}

.skeleton-icon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    background: linear-gradient(90deg, #dee2e6 25%, #e9ecef 50%, #dee2e6 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
}

.skeleton-text {
    height: 16px;
    border-radius: 4px;
    background: linear-gradient(90deg, #dee2e6 25%, #e9ecef 50%, #dee2e6 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
}

.skeleton-pulse {
    animation: skeleton-pulse 1s ease-in-out infinite;
}

/* Progressive loading styles */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.park-card-appear {
    animation: fadeInUp 0.4s ease-out forwards;
}

.park-skeleton {
    opacity: 0.6;
    border: 1px dashed #dee2e6 !important;
}

.park-skeleton .card-header {
    background: linear-gradient(90deg, #f8f9fa 25%, #fff 50%, #f8f9fa 75%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite;
}

.park-result-ok {
    border-left: 4px solid #28a745 !important;
}

.park-result-missing {
    border-left: 4px solid #dc3545 !important;
}

.progress-info .progress {
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress-info .progress-bar {
    background: linear-gradient(90deg, #696cff, #8592ff);
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
{% if snapshot_date %}
<div class="alert alert-info text-center mb-4">
    <i class="bi bi-clock-history me-2"></i>
    Données issues du dernier snapshot le {{ snapshot_date }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger" data-translate="error">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ translate(error) }}
</div>
{% else %}

<!-- Navigation tabs -->
<div class="nav-align-top mb-4">
    <ul class="nav nav-pills mb-3 flex-wrap" role="tablist">
        {% for country in countries %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}"
                    data-bs-toggle="pill"
                    data-bs-target="#{{ country|lower }}"
                    type="button"
                    role="tab">
                <i class="bi bi-geo-alt me-1"></i> {{ country }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Tab content -->
    <div class="tab-content p-0">
        {% for country in countries %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
             id="{{ country|lower }}"
             role="tabpanel"
             data-country="{{ country }}"
             data-loaded="false">

            <div class="country-loading">
                <!-- Progress info -->
                <div class="progress-info mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="progress-status text-muted">
                            <i class="bi bi-hourglass-split me-2 skeleton-pulse"></i>
                            <span data-translate="loading_parks">{{ translate('loading_parks') or 'Chargement des parcs...' }}</span>
                        </span>
                        <span class="progress-counter badge bg-primary">0 / ?</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Parks will be loaded here progressively -->
                <div class="parks-progressive-container"></div>
            </div>

            <div class="country-results" style="display: none;">
                <!-- Les résultats seront injectés ici -->
            </div>

            <div class="country-error alert alert-danger" style="display: none;">
                <!-- Les erreurs seront affichées ici -->
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Initialiser les traductions au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const currentLang = document.documentElement.lang;
});

// Fonction pour charger les résultats d'un pays (chargement progressif)
async function loadCountryResults(country, searchType, parc) {
    const tabPane = document.querySelector(`#${country.toLowerCase()}`);
    if (!tabPane || tabPane.getAttribute('data-loaded') === 'true') return;

    let lang = document.documentElement.lang || 'fr';
    const loadingContainer = tabPane.querySelector('.country-loading');
    const resultsContainer = tabPane.querySelector('.country-results');
    const progressContainer = tabPane.querySelector('.parks-progressive-container');
    const progressBar = tabPane.querySelector('.progress-bar');
    const progressCounter = tabPane.querySelector('.progress-counter');
    const progressStatus = tabPane.querySelector('.progress-status');

    // Si on est sur /results_from_snapshot, utiliser l'ancienne méthode
    if (window.location.pathname.startsWith('/results_from_snapshot')) {
        return loadCountryResultsFromSnapshot(country, searchType, parc, tabPane, lang);
    }

    try {
        // 1. Obtenir la liste des parcs
        let parks = [];
        if (parc === 'Tous') {
            const listResponse = await fetch(`/api/parks_list?country=${country}`);
            const listData = await listResponse.json();
            parks = listData.parks || [];
        } else {
            parks = [parc];
        }

        if (parks.length === 0) {
            loadingContainer.style.display = 'none';
            resultsContainer.innerHTML = `<div class="alert alert-secondary"><i class="bi bi-info-circle me-2"></i>${lang === 'en' ? 'No park found.' : 'Aucun parc trouvé.'}</div>`;
            resultsContainer.style.display = 'block';
            return;
        }

        // 2. Créer les skeleton cards pour chaque parc
        progressCounter.textContent = `0 / ${parks.length}`;
        parks.forEach(parkName => {
            const skeletonHtml = `
                <div class="card mb-3 park-skeleton" data-park="${parkName}">
                    <div class="card-header d-flex align-items-center">
                        <div class="skeleton-icon me-2"></div>
                        <div class="skeleton-text" style="width: 200px;"></div>
                        <span class="ms-auto text-muted small">${parkName}</span>
                    </div>
                </div>
            `;
            progressContainer.insertAdjacentHTML('beforeend', skeletonHtml);
        });

        // 3. Charger chaque parc progressivement
        const parksOk = [];
        const parksMissing = [];
        let loaded = 0;

        for (const parkName of parks) {
            progressStatus.innerHTML = `<i class="bi bi-search me-2"></i>${lang === 'en' ? 'Scanning' : 'Analyse de'} <strong>${parkName}</strong>...`;

            try {
                const response = await fetch(`/api/search_park?country=${country}&park=${encodeURIComponent(parkName)}&type=${encodeURIComponent(searchType)}`);
                const data = await response.json();

                // Déterminer si le parc a des photos manquantes
                const hasMissing = parkHasMissingPhotosFromResult(data.result, searchType);

                // Supprimer le skeleton
                const skeleton = progressContainer.querySelector(`[data-park="${parkName}"]`);
                if (skeleton) skeleton.remove();

                // Stocker le résultat
                if (hasMissing) {
                    parksMissing.push({ name: parkName, data: data.result });
                } else {
                    parksOk.push({ name: parkName, data: data.result });
                }

            } catch (err) {
                console.error(`Erreur pour ${parkName}:`, err);
                const skeleton = progressContainer.querySelector(`[data-park="${parkName}"]`);
                if (skeleton) skeleton.remove();
            }

            loaded++;
            progressBar.style.width = `${(loaded / parks.length) * 100}%`;
            progressCounter.textContent = `${loaded} / ${parks.length}`;
        }

        // 4. Afficher les résultats finaux
        loadingContainer.style.display = 'none';

        let resultsHtml = '';
        const hasMissingPhotos = parksMissing.length > 0;

        const isRestaurants = searchType === 'Restaurants';
        const isHousings = searchType === 'Hébergements';
        const isActivities = searchType === 'Activités';
        const isSurroundings = searchType === 'Aux alentours';

        // Afficher le bandeau global
        resultsHtml += `
            <div class="alert ${hasMissingPhotos ? 'alert-warning' : 'alert-success'} mb-4 d-flex align-items-center park-card-appear">
                <i class="bi bi-${hasMissingPhotos ? 'exclamation-triangle-fill' : 'check-circle-fill'} me-2 fs-5"></i>
                <span>${hasMissingPhotos ? (lang === 'en' ? 'Missing pictures' : 'Photos manquantes') : (lang === 'en' ? 'Pictures OK' : 'Photos OK')}</span>
            </div>
        `;

        function safeId(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '');
        }

        // Section "Photos manquantes"
        if (parksMissing.length > 0) {
            resultsHtml += `<h5 class="mb-3 text-danger park-card-appear"><i class="bi bi-exclamation-triangle-fill me-2"></i>${lang === 'en' ? 'Missing photos' : 'Photos manquantes'} <span class="badge bg-danger">${parksMissing.length}</span></h5>`;
            let accordionIdMissing = `accordion-${country.toLowerCase()}-missing`;
            resultsHtml += `<div class="accordion mb-4" id="${accordionIdMissing}">`;
            parksMissing.forEach((park, index) => {
                let safePanel = safeId(`${country}-${park.name}`);
                let panelId = `${accordionIdMissing}-panel-${safePanel}`;
                let headingId = `${panelId}-heading`;
                let collapseId = `${panelId}-collapse`;
                resultsHtml += buildParkAccordionItem(park.name, park.data, panelId, headingId, collapseId, accordionIdMissing, isActivities, isRestaurants, isHousings, lang, '', isSurroundings);
            });
            resultsHtml += `</div>`;
        }

        // Section "Parcs OK"
        if (parksOk.length > 0) {
            resultsHtml += `<h5 class="mb-3 text-success park-card-appear"><i class="bi bi-check-circle-fill me-2"></i>${lang === 'en' ? 'Parks OK' : 'Parcs OK'} <span class="badge bg-success">${parksOk.length}</span></h5>`;
            let accordionIdOk = `accordion-${country.toLowerCase()}-ok`;
            resultsHtml += `<div class="accordion mb-4" id="${accordionIdOk}">`;
            parksOk.forEach((park, index) => {
                let safePanel = safeId(`${country}-${park.name}`);
                let panelId = `${accordionIdOk}-panel-${safePanel}`;
                let headingId = `${panelId}-heading`;
                let collapseId = `${panelId}-collapse`;
                resultsHtml += buildParkAccordionItem(park.name, park.data, panelId, headingId, collapseId, accordionIdOk, isActivities, isRestaurants, isHousings, lang, '', isSurroundings);
            });
            resultsHtml += `</div>`;
        }

        // Afficher les résultats
        resultsContainer.innerHTML = resultsHtml;
        resultsContainer.style.display = 'block';
        updateTranslations(resultsContainer);
        tabPane.setAttribute('data-loaded', 'true');

    } catch (error) {
        loadingContainer.style.display = 'none';
        const errorContainer = tabPane.querySelector('.country-error');
        errorContainer.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i> Erreur : ${error.message}`;
        errorContainer.style.display = 'block';
    }
}

// Fonction pour vérifier si un parc a des photos manquantes
function parkHasMissingPhotosFromResult(parkData, searchType) {
    if (!parkData) return false;

    if (searchType === 'Activités' && parkData.activities) {
        for (const a of parkData.activities) {
            if (!a.has_photos) return true;
        }
    }
    if (searchType === 'Restaurants') {
        const sections = ['restaurants', 'supermarches', 'services', 'forfaits'];
        for (const section of sections) {
            if (parkData[section]) {
                for (const r of parkData[section]) {
                    if (!r.has_photos) return true;
                }
            }
        }
    }
    if (searchType === 'Hébergements' && parkData.housings) {
        for (const h of parkData.housings) {
            if (!h.has_photos) return true;
        }
    }
    if (searchType === 'Aux alentours' && parkData.surroundings) {
        for (const s of parkData.surroundings) {
            if (!s.has_photos) return true;
        }
    }
    return false;
}

// Fonction pour charger depuis un snapshot (méthode classique)
async function loadCountryResultsFromSnapshot(country, searchType, parc, tabPane, lang) {
    try {
        const apiUrl = `/api/snapshot_results?country=${country}&parc=${parc}&type=${searchType}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.error) throw new Error(data.error);

        tabPane.querySelector('.country-loading').style.display = 'none';
        const resultsContainer = tabPane.querySelector('.country-results');

        const isRestaurants = searchType === 'Restaurants';
        const isHousings = searchType === 'Hébergements';
        const isActivities = searchType === 'Activités';
        const isSurroundings = searchType === 'Aux alentours';

        let parksWithMissing = [];
        let parksOk = [];

        for (const [parkName, parkData] of Object.entries(data.results[country] || {})) {
            if (parkHasMissingPhotosFromResult(parkData, searchType)) {
                parksWithMissing.push({ name: parkName, data: parkData });
            } else {
                parksOk.push({ name: parkName, data: parkData });
            }
        }

        let resultsHtml = '';
        const hasMissingPhotos = parksWithMissing.length > 0;

        resultsHtml += `
            <div class="alert ${hasMissingPhotos ? 'alert-warning' : 'alert-success'} mb-4 d-flex align-items-center">
                <i class="bi bi-${hasMissingPhotos ? 'exclamation-triangle-fill' : 'check-circle-fill'} me-2 fs-5"></i>
                <span>${hasMissingPhotos ? (lang === 'en' ? 'Missing pictures' : 'Photos manquantes') : (lang === 'en' ? 'Pictures OK' : 'Photos OK')}</span>
            </div>
        `;

        function safeId(str) { return str.replace(/[^a-zA-Z0-9]/g, ''); }

        if (parksWithMissing.length > 0) {
            resultsHtml += `<h5 class="mb-3 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>${lang === 'en' ? 'Missing photos' : 'Photos manquantes'} <span class="badge bg-danger">${parksWithMissing.length}</span></h5>`;
            let accordionId = `accordion-${country.toLowerCase()}-missing`;
            resultsHtml += `<div class="accordion mb-4" id="${accordionId}">`;
            parksWithMissing.forEach(park => {
                let safePanel = safeId(`${country}-${park.name}`);
                resultsHtml += buildParkAccordionItem(park.name, park.data, `${accordionId}-panel-${safePanel}`, `${accordionId}-panel-${safePanel}-heading`, `${accordionId}-panel-${safePanel}-collapse`, accordionId, isActivities, isRestaurants, isHousings, lang, '', isSurroundings);
            });
            resultsHtml += `</div>`;
        }

        if (parksOk.length > 0) {
            resultsHtml += `<h5 class="mb-3 text-success"><i class="bi bi-check-circle-fill me-2"></i>${lang === 'en' ? 'Parks OK' : 'Parcs OK'} <span class="badge bg-success">${parksOk.length}</span></h5>`;
            let accordionId = `accordion-${country.toLowerCase()}-ok`;
            resultsHtml += `<div class="accordion mb-4" id="${accordionId}">`;
            parksOk.forEach(park => {
                let safePanel = safeId(`${country}-${park.name}`);
                resultsHtml += buildParkAccordionItem(park.name, park.data, `${accordionId}-panel-${safePanel}`, `${accordionId}-panel-${safePanel}-heading`, `${accordionId}-panel-${safePanel}-collapse`, accordionId, isActivities, isRestaurants, isHousings, lang, '', isSurroundings);
            });
            resultsHtml += `</div>`;
        }

        resultsContainer.innerHTML = resultsHtml;
        resultsContainer.style.display = 'block';
        tabPane.setAttribute('data-loaded', 'true');

    } catch (error) {
        tabPane.querySelector('.country-loading').style.display = 'none';
        const errorContainer = tabPane.querySelector('.country-error');
        errorContainer.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i> Erreur : ${error.message}`;
        errorContainer.style.display = 'block';
    }
}

// Fonction pour construire un élément d'accordéon de parc
function buildParkAccordionItem(parkName, parkData, panelId, headingId, collapseId, accordionId, isActivities, isRestaurants, isHousings, lang, prefix, isSurroundings) {
    let html = `
    <div class="accordion-item card mb-3">
        <h2 class="accordion-header" id="${headingId}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                <i class="bi bi-pin-map me-2"></i> ${prefix}${parkName}
            </button>
        </h2>
        <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" data-bs-parent="#${accordionId}">
            <div class="accordion-body">`;

    if (isActivities) {
        html += buildActivitiesSection(parkData, panelId, lang);
    }

    if (isRestaurants) {
        html += buildRestaurantsSection(parkData, panelId, lang);
    }

    if (isHousings) {
        html += buildHousingsSection(parkData, panelId, lang);
    }

    if (isSurroundings) {
        html += buildSurroundingsSection(parkData, panelId, lang);
    }

    html += `</div></div></div>`;
    return html;
}

// Fonction pour construire la section activités
function buildActivitiesSection(parkData, panelId, lang) {
    const activities = Array.isArray(parkData.activities) ? parkData.activities : [];
    // Utiliser has_photos calculé par le backend
    const missing = activities.filter(a => !a.has_photos);
    const ok = activities.filter(a => a.has_photos);
    const allPhotosOk = activities.length > 0 && missing.length === 0;

    let html = '<div>';

    if (activities.length === 0) {
        html += `<div class="alert alert-secondary"><i class="bi bi-info-circle me-2"></i>${lang === 'en' ? 'No activity found.' : 'Aucune activité trouvée.'}</div>`;
    } else if (allPhotosOk) {
        html += `<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>${lang === 'en' ? 'All activities in this park have a valid photo.' : 'Toutes les activités de ce parc possèdent une photo valide.'}</div>`;
        html += buildOkItemsAccordion(ok, panelId, 'activities', lang, 'activity');
    } else {
        if (missing.length > 0) {
            html += `<h6 class="mb-3"><i class="bi bi-exclamation-circle text-danger me-2"></i>${lang === 'en' ? 'Activities with missing pictures' : 'Activités avec photo manquante'}</h6>`;
            html += `<div class="table-responsive"><table class="table table-hover"><tbody>`;
            missing.forEach(a => {
                html += `<tr>
                    <td>${a.name}</td>
                    <td class="text-end"><span class="badge bg-label-danger"><i class="bi bi-exclamation-circle"></i> ${lang === 'en' ? 'missing' : 'photo manquante'}</span></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        }
        html += buildOkItemsAccordion(ok, panelId, 'activities', lang, 'activity');
    }

    html += '</div>';
    return html;
}

// Fonction pour construire la section restaurants
function buildRestaurantsSection(parkData, panelId, lang) {
    let html = '<div>';

    const sections = [
        { key: 'restaurants', label: 'Restaurants', icon: 'cup-hot' },
        { key: 'supermarches', label: 'Supermarchés & boutiques', icon: 'cart' },
        { key: 'services', label: 'Services', icon: 'gear' },
        { key: 'forfaits', label: 'Forfaits', icon: 'ticket' }
    ];

    sections.forEach(section => {
        const items = Array.isArray(parkData[section.key]) ? parkData[section.key] : [];
        html += `<h6 class="mb-3"><i class="bi bi-${section.icon} me-2"></i>${section.label}</h6>`;

        if (items.length > 0) {
            html += `<div class="table-responsive mb-4"><table class="table table-hover"><tbody>`;
            items.forEach(r => {
                const hasPhoto = r.has_photos === true || r.has_photos === 'true' || r.has_photos === 1 || r.has_photos === '1';
                html += `<tr>
                    <td>${r.name}</td>
                    <td class="text-end">
                        <span class="badge ${hasPhoto ? 'bg-label-success' : 'bg-label-danger'}">
                            <i class="bi bi-${hasPhoto ? 'check-circle' : 'exclamation-circle'}"></i>
                            ${hasPhoto ? 'photo ok' : 'photo manquante'}
                        </span>
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            html += `<p class="text-muted mb-4">${lang === 'en' ? 'None' : 'Aucun'}</p>`;
        }
    });

    html += '</div>';
    return html;
}

// Fonction pour construire la section hébergements
function buildHousingsSection(parkData, panelId, lang) {
    const housings = Array.isArray(parkData.housings) ? parkData.housings : [];
    // Utiliser has_photos calculé par le backend
    const missing = housings.filter(h => !h.has_photos);
    const ok = housings.filter(h => h.has_photos);
    const allPhotosOk = housings.length > 0 && missing.length === 0;

    let html = '<div>';

    if (housings.length === 0) {
        html += `<div class="alert alert-secondary"><i class="bi bi-info-circle me-2"></i>${lang === 'en' ? 'No accommodation found.' : 'Aucun hébergement trouvé.'}</div>`;
    } else if (allPhotosOk) {
        html += `<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>${lang === 'en' ? 'All accommodations in this park have a valid photo.' : 'Tous les hébergements de ce parc possèdent une photo valide.'}</div>`;
        html += buildOkHousingsAccordion(ok, panelId, lang);
    } else {
        if (missing.length > 0) {
            html += `<h6 class="mb-3"><i class="bi bi-exclamation-circle text-danger me-2"></i>${lang === 'en' ? 'Accommodations with missing pictures' : 'Hébergements avec photo manquante'}</h6>`;
            html += `<div class="table-responsive mb-4"><table class="table table-hover"><tbody>`;
            missing.forEach(h => {
                html += `<tr>
                    <td>
                        <strong>${h.cottage_id}</strong> — ${h.type} — ${h.capacity} pers.<br>
                        <small class="text-muted">${h.name}</small>
                    </td>
                    <td class="text-end"><span class="badge bg-label-danger"><i class="bi bi-exclamation-circle"></i> photo manquante</span></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        }
        html += buildOkHousingsAccordion(ok, panelId, lang);
    }

    html += '</div>';
    return html;
}

// Fonction pour construire la section aux alentours
function buildSurroundingsSection(parkData, panelId, lang) {
    const surroundings = Array.isArray(parkData.surroundings) ? parkData.surroundings : [];
    const missing = surroundings.filter(s => !s.has_photos);
    const ok = surroundings.filter(s => s.has_photos);
    const allPhotosOk = surroundings.length > 0 && missing.length === 0;

    let html = '<div>';

    if (surroundings.length === 0) {
        html += `<div class="alert alert-secondary"><i class="bi bi-info-circle me-2"></i>${lang === 'en' ? 'No surrounding place found.' : 'Aucun lieu aux alentours trouvé.'}</div>`;
    } else if (allPhotosOk) {
        html += `<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>${lang === 'en' ? 'All surrounding places have a valid photo.' : 'Tous les lieux aux alentours possèdent une photo valide.'}</div>`;
        html += buildOkItemsAccordion(ok, panelId, 'surroundings', lang, 'surrounding');
    } else {
        if (missing.length > 0) {
            html += `<h6 class="mb-3"><i class="bi bi-exclamation-circle text-danger me-2"></i>${lang === 'en' ? 'Surrounding places with missing pictures' : 'Lieux aux alentours avec photo manquante'}</h6>`;
            html += `<div class="table-responsive"><table class="table table-hover"><tbody>`;
            missing.forEach(s => {
                html += `<tr>
                    <td>${s.name}</td>
                    <td class="text-end"><span class="badge bg-label-danger"><i class="bi bi-exclamation-circle"></i> ${lang === 'en' ? 'missing' : 'photo manquante'}</span></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        }
        html += buildOkItemsAccordion(ok, panelId, 'surroundings', lang, 'surrounding');
    }

    html += '</div>';
    return html;
}

// Fonction pour construire l'accordéon des items OK
function buildOkItemsAccordion(items, panelId, type, lang, itemType) {
    if (items.length === 0) return '';

    const collapseId = `${panelId}-ok-${type}-collapse`;
    let html = `
    <div class="accordion mt-3" id="${panelId}-ok-${type}-accordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="${panelId}-ok-${type}-heading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    ${lang === 'en' ? `See ${type} with photo` : `Voir les ${type === 'activities' ? 'activités' : 'éléments'} avec photo OK`}
                    <span class="badge bg-success ms-2">${items.length}</span>
                </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse">
                <div class="accordion-body p-0">
                    <div class="table-responsive"><table class="table table-hover mb-0"><tbody>`;

    items.forEach(item => {
        html += `<tr>
            <td>${item.name}</td>
            <td class="text-end"><span class="badge bg-label-success"><i class="bi bi-check-circle"></i> photo ok</span></td>
        </tr>`;
    });

    html += `</tbody></table></div></div></div></div></div>`;
    return html;
}

// Fonction pour construire l'accordéon des hébergements OK
function buildOkHousingsAccordion(items, panelId, lang) {
    if (items.length === 0) return '';

    const collapseId = `${panelId}-ok-housings-collapse`;
    let html = `
    <div class="accordion mt-3" id="${panelId}-ok-housings-accordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="${panelId}-ok-housings-heading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    ${lang === 'en' ? 'See accommodations with photo' : 'Voir les hébergements avec photo OK'}
                    <span class="badge bg-success ms-2">${items.length}</span>
                </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse">
                <div class="accordion-body p-0">
                    <div class="table-responsive"><table class="table table-hover mb-0"><tbody>`;

    items.forEach(h => {
        html += `<tr>
            <td>
                <strong>${h.cottage_id}</strong> — ${h.type} — ${h.capacity} pers.<br>
                <small class="text-muted">${h.name}</small>
            </td>
            <td class="text-end"><span class="badge bg-label-success"><i class="bi bi-check-circle"></i> photo ok</span></td>
        </tr>`;
    });

    html += `</tbody></table></div></div></div></div></div>`;
    return html;
}

// Gestionnaire d'événements pour le changement d'onglet (ne fait plus rien si déjà en cours)
document.addEventListener('shown.bs.tab', function (event) {
    // Les résultats sont déjà chargés en parallèle, pas besoin de recharger
});

// Charger TOUS les pays en parallèle au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const searchType = new URLSearchParams(window.location.search).get('type');
    const parc = new URLSearchParams(window.location.search).get('parc');
    const urlCountry = new URLSearchParams(window.location.search).get('country');

    // Récupérer tous les onglets de pays
    const allCountryTabs = document.querySelectorAll('.nav-link[data-bs-toggle="pill"]');
    const countries = Array.from(allCountryTabs).map(tab => tab.textContent.trim());

    if (urlCountry === 'Tous' && countries.length > 1) {
        // Lancer TOUS les pays en parallèle
        console.log('Lancement du scan parallèle pour tous les pays:', countries);
        countries.forEach(country => {
            loadCountryResults(country, searchType, parc);
        });
    } else {
        // Un seul pays sélectionné
        const firstCountry = document.querySelector('.nav-link.active').textContent.trim();
        loadCountryResults(firstCountry, searchType, parc);
    }
});

// Fonction pour mettre à jour les traductions après le chargement dynamique
function updateTranslations(container) {
    const currentLang = document.documentElement.lang;
    fetch(`/set_language/${currentLang}?next=${encodeURIComponent(window.location.pathname + window.location.search)}`, {
        method: 'GET',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            container.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (data.translations && data.translations[key]) {
                    element.textContent = data.translations[key];
                }
            });
        }
    });
}
</script>
{% endblock %}
